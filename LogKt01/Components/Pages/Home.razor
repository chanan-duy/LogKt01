@page "/"
@using LogKt01.Dto
@using LogKt01.Services
@rendermode InteractiveServer
@inject ILogger<Home> Logger
@inject TaskManagerService TaskManager

<PageTitle>Task Manager</PageTitle>

<div class="container mt-4">
	<h1 class="mb-4">Task Manager</h1>

	<div class="card mb-4">
		<div class="card-body">
			<div class="input-group">
				<input @bind="_newTaskTitle"
				       @bind:event="oninput"
				       @onkeyup="HandleEnter"
				       class="form-control"
				       placeholder="Task title..."/>

				<input @bind="_newTaskCategory"
				       @bind:event="oninput"
				       @onkeyup="HandleEnter"
				       class="form-control"
				       placeholder="Category..."/>

				<button class="btn btn-primary" @onclick="AddTask" disabled="@_isProcessing">
					@(_isProcessing ? "Adding..." : "Add Task")
				</button>
			</div>
			@if (!string.IsNullOrEmpty(_errorMessage))
			{
				<div class="text-danger mt-2">@_errorMessage</div>
			}
		</div>
	</div>

	<h3>Task List:</h3>

	@if (_isLoading)
	{
		<div class="spinner-border text-primary" role="status">
			<span class="visually-hidden">Loading...</span>
		</div>
	}
	else if (_tasks.Any())
	{
		<ul class="list-group">
			@{ var counter = 1; }
			@foreach (var task in _tasks)
			{
				<li class="list-group-item d-flex justify-content-between align-items-center">
					<div>
						<span class="fw-bold me-2">@(counter++).</span>

						@if (!string.IsNullOrEmpty(task.Category))
						{
							<span class="badge bg-secondary me-2">@task.Category</span>
						}

						@task.Title
					</div>
					<button class="btn btn-danger btn-sm" @onclick="() => RemoveTask(task.Id)">Remove</button>
				</li>
			}
		</ul>
	}
	else
	{
		<div class="alert alert-info">Empty</div>
	}
</div>

@code {
	private string _newTaskTitle = "";
	private string _newTaskCategory = "";
	private string _errorMessage = "";
	private List<TaskDto> _tasks = [];

	private bool _isLoading = true;
	private bool _isProcessing;

	protected override async Task OnInitializedAsync()
	{
		await LoadTasks();
	}

	private async Task LoadTasks()
	{
		try
		{
			_isLoading = true;
			_tasks = await TaskManager.GetAllTasks();
		}
		catch (Exception e)
		{
			Logger.LogError(e, "Error loading tasks");
			_errorMessage = "Failed to load tasks";
		}
		finally
		{
			_isLoading = false;
		}
	}

	private async Task AddTask()
	{
		if (string.IsNullOrWhiteSpace(_newTaskTitle))
		{
			_errorMessage = "Title can't be empty";
			return;
		}

		if (string.IsNullOrWhiteSpace(_newTaskCategory))
		{
			_errorMessage = "Category can't be empty";
			return;
		}

		_isProcessing = true;
		_errorMessage = "";

		Logger.LogInformation("Adding task: {Title} - {Category}", _newTaskTitle, _newTaskCategory);

		try
		{
			var success = await TaskManager.AddTask(_newTaskTitle, _newTaskCategory);

			if (success)
			{
				_newTaskTitle = "";
				_newTaskCategory = "";
				await LoadTasks();
			}
			else
			{
				_errorMessage = "Error while adding task";
			}
		}
		catch (Exception ex)
		{
			Logger.LogError(ex, "Error while adding task");
			_errorMessage = "Unexpected error occurred";
		}
		finally
		{
			_isProcessing = false;
		}
	}

	private async Task RemoveTask(int id)
	{
		await TaskManager.RemoveTask(id);
		await LoadTasks();
	}

	private async Task HandleEnter(KeyboardEventArgs e)
	{
		if (e.Key == "Enter")
		{
			await AddTask();
		}
	}

}
